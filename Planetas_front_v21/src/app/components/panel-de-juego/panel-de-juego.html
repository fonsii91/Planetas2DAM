<mat-sidenav-container class="game-sidenav-container">
  <mat-sidenav #sidenav mode="over" position="end" class="battle-log-sidenav">
    <div class="sidenav-header">
      <h3 class="tech-title blue-text">REGISTRO DE BATALLA</h3>
      <button mat-icon-button (click)="sidenav.close()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="log-content">
      <div class="log-messages">
        <div *ngFor="let mensaje of mensajesRonda" class="log-entry" [ngClass]="mensaje.tipo || 'info'">
          <mat-icon class="log-icon" *ngIf="mensaje.tipo === 'success'">check_circle</mat-icon>
          <mat-icon class="log-icon" *ngIf="mensaje.tipo === 'warning'">warning</mat-icon>
          <mat-icon class="log-icon" *ngIf="mensaje.tipo === 'danger'">error</mat-icon>
          <mat-icon class="log-icon" *ngIf="mensaje.tipo === 'round'">timer</mat-icon>
          <mat-icon class="log-icon" *ngIf="!mensaje.tipo || mensaje.tipo === 'info'">info</mat-icon>
          <span [innerHTML]="mensaje.texto"></span>
        </div>
      </div>
    </div>
  </mat-sidenav>

  <mat-sidenav-content>
    <div class="game-container">
      <div class="round-info">
        <h2 class="tech-title white-text">RONDA #{{ numeroRonda }}</h2>
      </div>

      <div class="enemies-grid">
        <mat-card class="player-card cyan-glow" [class.eliminated]="jugadorActual.vida <= 0">
          <mat-card-header>
            <div class="planet-image-container">
              <img [src]="getPlanetImage(jugadorActual.planeta.tipo)" alt="Planeta {{ jugadorActual.planeta.nombre }}"
                class="planet-icon">
              <!-- Floating Damage Number for Player (prepared for future AI implementation) -->
              <div class="damage-popup" *ngIf="damageDealt[jugadorActual.nombre]">
                -{{ damageDealt[jugadorActual.nombre] }}
              </div>
            </div>
            <div class="header-text">
              <mat-card-title class="tech-title cyan-text">{{ jugadorActual.nombre }}</mat-card-title>
              <mat-card-subtitle class="tech-subtitle">Tu Planeta: {{ jugadorActual.planeta.nombre }} (Tipo: {{
                jugadorActual.planeta.tipo }})</mat-card-subtitle>
              <div class="health-container">
                <span class="orange-text">Vida: {{ jugadorActual.vida }} / {{ jugadorActual.vidaMaxima }}</span>

                <!-- Custom Segmented Health Bar - Player -->
                <div class="custom-health-bar-container player-health"
                  [class.health-low]="jugadorActual.vida < jugadorActual.vidaMaxima * 0.3">
                  <div *ngFor="let active of getHealthSegments(jugadorActual.vida, jugadorActual.vidaMaxima)"
                    class="health-block" [class.active]="active"></div>
                </div>
              </div>
            </div>
          </mat-card-header>
          <mat-card-content>

            <div class="missile-controls-header">
              <mat-icon class="label-icon">shield</mat-icon>
              <span class="control-label">MISILES A DEFENSA </span>
            </div>
            <div class="missile-controls">
              <div class="tech-input-number"
                style="display: flex; align-items: center; justify-content: center; cursor: default;">
                {{ misilesDefensa }}
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card *ngFor="let enemigo of enemigos" class="enemy-card red-glow" [class.eliminated]="enemigo.vida <= 0">
          <mat-card-header>
            <div class="planet-image-container">
              <div class="shake-wrapper" [class.shake-active]="damageDealt[enemigo.nombre]">
                <img [src]="getPlanetImage(enemigo.planeta.tipo)" alt="Planeta {{ enemigo.planeta.nombre }}"
                  class="planet-icon">
                <div class="explosion-effect" *ngIf="damageDealt[enemigo.nombre]"></div>
              </div>
              <!-- Floating Damage Number -->
              <div class="damage-popup" *ngIf="damageDealt[enemigo.nombre]">
                -{{ damageDealt[enemigo.nombre] }}
              </div>
            </div>
            <div class="header-text">
              <mat-card-title class="tech-title red-text">{{ enemigo.nombre }}</mat-card-title>
              <mat-card-subtitle class="tech-subtitle">Planeta: {{ enemigo.planeta.nombre }} (Tipo: {{
                enemigo.planeta.tipo
                }})</mat-card-subtitle>
              <div class="health-container">
                <span class="red-text">Vida: {{ enemigo.vida }} / {{ enemigo.vidaMaxima }}</span>

                <!-- Custom Segmented Health Bar - Enemy -->
                <div class="custom-health-bar-container enemy-health"
                  [class.health-low]="enemigo.vida < enemigo.vidaMaxima * 0.3">
                  <div *ngFor="let active of getHealthSegments(enemigo.vida, enemigo.vidaMaxima)" class="health-block"
                    [class.active]="active"></div>
                </div>
              </div>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="missile-controls-header">
              <mat-icon class="label-icon">rocket_launch</mat-icon>
              <span class="control-label">ENVIAR MISILES</span>
            </div>
            <div class="missile-controls">
              <button class="control-btn" (click)="adjustMissiles(enemigo, -1)"
                [disabled]="ataques[enemigo.nombre].misiles <= 0">
                <mat-icon>remove</mat-icon>
              </button>

              <input type="number" class="tech-input-number" [(ngModel)]="ataques[enemigo.nombre].misiles"
                (change)="validateInput(enemigo)" min="0" [max]="maxMisilesPorAtaque(enemigo)">

              <button class="control-btn" (click)="adjustMissiles(enemigo, 1)"
                [disabled]="ataques[enemigo.nombre].misiles >= maxMisilesPorAtaque(enemigo)">
                <mat-icon>add</mat-icon>
              </button>

              <button class="control-btn max-btn" (click)="setMaxMissiles(enemigo)"
                [disabled]="ataques[enemigo.nombre].misiles >= maxMisilesPorAtaque(enemigo)">
                MAX
              </button>
            </div>
            <div class="slider-info">
              <span class="cyan-text" style="font-size: 0.8em; opacity: 0.8;">
                Disp: {{ maxMisilesPorAtaque(enemigo) - ataques[enemigo.nombre].misiles }} / Total: {{
                maxMisilesPorAtaque(enemigo) }}
              </span>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="action-buttons">
        <button mat-flat-button class="btn-cyan" (click)="agregarEnemigo()" [disabled]="enemigos.length > 9">
          <mat-icon>person_add</mat-icon> AÃ‘ADIR JUGADOR
        </button>
        <button mat-flat-button class="btn-orange" (click)="lanzarAtaque()">LANZAR MISILES</button>


        <button mat-flat-button class="btn-blue" (click)="sidenav.toggle()">
          <mat-icon>history_edu</mat-icon>
          REGISTRO DE BATALLA
        </button>
      </div>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>